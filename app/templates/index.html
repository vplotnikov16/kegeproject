{% extends "base.html" %}

{% block title %}Главная - Статистика и аналитика{% endblock %}

{% block head %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/index.css') }}"/>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container-fluid">
        <div style="margin-bottom: 30px;">
            <h1 style="color: #333; margin-bottom: 5px;">Статистика и аналитика</h1>
            <p style="color: #666; margin: 0;">Обзор активности системы и результатов экзаменов</p>
        </div>

        <div class="row" style="margin-bottom: 30px;">
            <div class="col-md-3 col-sm-6">
                <div class="stat-card blue">
                    <div class="stat-label">Всего пользователей</div>
                    <div class="stat-number">{{ dashboard_data.total_stats.total_users }}</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stat-card green">
                    <div class="stat-label">Всего задач</div>
                    <div class="stat-number">{{ dashboard_data.total_stats.total_tasks }}</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stat-card orange">
                    <div class="stat-label">Всего вариантов</div>
                    <div class="stat-number">{{ dashboard_data.total_stats.total_variants }}</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stat-card purple">
                    <div class="stat-label">Попыток решения</div>
                    <div class="stat-number">{{ dashboard_data.total_stats.total_attempts }}</div>
                </div>
            </div>
        </div>

        <div class="row" style="margin-bottom: 30px;">
            <div class="col-md-3 col-sm-6">
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="stat-label">Новых пользователей (7 дней)</div>
                    <div class="stat-number">{{ dashboard_data.activity_stats.new_users }}</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="stat-label">Новых задач (7 дней)</div>
                    <div class="stat-number">{{ dashboard_data.activity_stats.new_tasks }}</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="stat-label">Новых вариантов (7 дней)</div>
                    <div class="stat-number">{{ dashboard_data.activity_stats.new_variants }}</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <div class="stat-label">Попыток (7 дней)</div>
                    <div class="stat-number">{{ dashboard_data.activity_stats.new_attempts }}</div>
                </div>
            </div>
        </div>

        {% if dashboard_data.latest_attempt %}
        <div class="latest-attempt">
            <div class="attempt-header">Последний решённый вариант</div>
            <div class="attempt-details">
                <div class="attempt-detail">
                    <div class="attempt-label">Пользователь</div>
                    <div class="attempt-value">{{ dashboard_data.latest_attempt.examinee_username }}</div>
                </div>
                <div class="attempt-detail">
                    <div class="attempt-label">Источник варианта</div>
                    <div class="attempt-value">{{ dashboard_data.latest_attempt.variant_source }}</div>
                </div>
                <div class="attempt-detail">
                    <div class="attempt-label">Правильных ответов</div>
                    <div class="attempt-value">{{ dashboard_data.latest_attempt.correct_answers }}/{{
                        dashboard_data.latest_attempt.total_answers }}
                    </div>
                </div>
                <div class="attempt-detail">
                    <div class="attempt-label">Результат</div>
                    <div class="attempt-value" style="color: #4ade80;">{{ dashboard_data.latest_attempt.score }}%</div>
                </div>
                <div class="attempt-detail">
                    <div class="attempt-label">Дата завершения</div>
                    <div class="attempt-value">{{ dashboard_data.latest_attempt.finished_at }}</div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <p>Ещё нет завершённых попыток. Начните с создания варианта и решения задач!</p>
        </div>
        {% endif %}

        <h2 class="section-title">Аналитика результатов</h2>
        <div class="row">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 style="margin-bottom: 15px; color: #333;">Распределение оценок (30 дней)</h5>
                    <canvas id="scoreDistributionChart"></canvas>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 style="margin-bottom: 15px; color: #333;">Средние баллы по неделям</h5>
                    <canvas id="weeklyScoresChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Lists Section -->
        <h2 class="section-title">Таблицы лидеров и новинки</h2>
        <div class="row">
            <!-- Recent Users -->
            <div class="col-lg-4">
                <div class="list-container">
                    <h5 style="margin-bottom: 15px; color: #333;">Последние зарегистрировавшиеся</h5>
                    {% if dashboard_data.recent_users %}
                    {% for user in dashboard_data.recent_users %}
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-title">{{ user.username }}</div>
                            <div class="item-subtitle">{{ user.first_name }} {{ user.last_name }}</div>
                        </div>
                        <div class="item-meta">{{ user.registered_at }}</div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state" style="padding: 20px;">
                        <p style="margin: 0;">Нет пользователей</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Top Performers -->
            <div class="col-lg-4">
                <div class="list-container">
                    <h5 style="margin-bottom: 15px; color: #333;">Лучшие результаты (30 дней)</h5>
                    {% if dashboard_data.top_performers %}
                    {% for performer in dashboard_data.top_performers %}
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-title">#{{ loop.index }}. {{ performer.username }}</div>
                            <div class="item-subtitle">{{ performer.attempts_count }} попыт{{ 'ок' if
                                performer.attempts_count % 10 >= 5 or performer.attempts_count % 10 == 0 else ('и' if
                                performer.attempts_count % 10 != 1 else 'ы') }}
                            </div>
                        </div>
                        <div class="item-meta" style="color: #4ade80; font-weight: bold;">{{ performer.average_score
                            }}%
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state" style="padding: 20px;">
                        <p style="margin: 0;">Ещё нет результатов</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Tasks -->
            <div class="col-lg-4">
                <div class="list-container">
                    <h5 style="margin-bottom: 15px; color: #333;">Последние добавленные задачи</h5>
                    {% if dashboard_data.recent_tasks %}
                    {% for task in dashboard_data.recent_tasks %}
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-title">Задание №{{ task.number }}</div>
                            <div class="item-subtitle">{{ task.author_username }} • {{ task.published_at }}</div>
                        </div>
                        <div class="item-meta">{{ task.variants_count }} вар.</div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state" style="padding: 20px;">
                        <p style="margin: 0;">Нет задач</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <h2 class="section-title">Недавние варианты экзаменов</h2>
        <div class="list-container">
            {% if dashboard_data.recent_variants %}
            <div style="overflow-x: auto;">
                <table class="table table-hover" style="margin-bottom: 0;">
                    <thead style="background: #f5f5f5;">
                    <tr>
                        <th>ID</th>
                        <th>Источник</th>
                        <th>Автор</th>
                        <th>Дата создания</th>
                        <th>Задач</th>
                        <th>Попыток</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for variant in dashboard_data.recent_variants %}
                    <tr>
                        <td><strong>#{{ variant.id }}</strong></td>
                        <td>{{ variant.source }}</td>
                        <td>{{ variant.author_username }}</td>
                        <td>{{ variant.created_at }}</td>
                        <td><span class="badge badge-primary">{{ variant.tasks_count }}</span></td>
                        <td><span class="badge badge-success">{{ variant.attempts_count }}</span></td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <p style="margin: 0;">Нет вариантов</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Score Distribution Chart
        const scoreDistCtx = document.getElementById('scoreDistributionChart');
        if (scoreDistCtx) {
            const scoreData = {{ dashboard_data.score_distribution|tojson }};

            new Chart(scoreDistCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(scoreData),
                    datasets: [{
                        data: Object.values(scoreData),
                        backgroundColor: [
                            '#ff6b6b',
                            '#ffa500',
                            '#ffd93d',
                            '#6bcf7f',
                            '#4ade80'
                        ],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    let suffix = 'ок';
                                    if (value === 1) suffix = 'а';
                                    else if (value > 1 && value < 5) suffix = 'и';
                                    return context.label + ': ' + value + ' попыт' + suffix;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Weekly Scores Chart
        const weeklyScoresCtx = document.getElementById('weeklyScoresChart');
        if (weeklyScoresCtx) {
            const weeklyData = {{ dashboard_data.weekly_scores|tojson }};

            if (weeklyData.length > 0) {
                const labels = weeklyData.map(w => w.week_start + ' - ' + w.week_end);
                const scores = weeklyData.map(w => w.average_score);
                const attempts = weeklyData.map(w => w.attempt_count);

                new Chart(weeklyScoresCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Средний балл (%)',
                            data: scores,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { font: { size: 12 } }
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        return 'Попыток: ' + attempts[context.dataIndex];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: { callback: function(value) { return value + '%'; } }
                            }
                        }
                    }
                });
            } else {
                weeklyScoresCtx.style.display = 'none';
                const container = weeklyScoresCtx.parentElement;
                if (container) {
                    container.innerHTML += '<div class="empty-state"><p class="text-muted">Недостаточно данных для отображения графика</p></div>';
                }
            }
        }
    });
</script>
{% endblock %}
